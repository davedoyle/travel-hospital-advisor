WITH ActiveService AS (
    SELECT service_id
    FROM calendar
    WHERE (
        (strftime('%w', 'now', 'localtime') = '1' AND monday = 1) OR
        (strftime('%w', 'now', 'localtime') = '2' AND tuesday = 1) OR
        (strftime('%w', 'now', 'localtime') = '3' AND wednesday = 1) OR
        (strftime('%w', 'now', 'localtime') = '4' AND thursday = 1) OR
        (strftime('%w', 'now', 'localtime') = '5' AND friday = 1) OR
        (strftime('%w', 'now', 'localtime') = '6' AND saturday = 1) OR
        (strftime('%w', 'now', 'localtime') = '0' AND sunday = 1)
    )
    AND start_date <= strftime('%Y%m%d', 'now', 'localtime')
    AND end_date   >= strftime('%Y%m%d', 'now', 'localtime')
),
WindowedTrips AS (
    SELECT 
        r.route_long_name,
        r.route_short_name,
        t.trip_headsign,
        t.trip_id,
        s.stop_id,
        s.arrival_time
    FROM stop_times s
    JOIN trips t ON s.trip_id = t.trip_id
    JOIN routes r ON t.route_id = r.route_id
    WHERE s.stop_id = '8370B243341'  -- CUH
      AND t.service_id IN (SELECT service_id FROM ActiveService)
      AND (
            time(s.arrival_time) BETWEEN time('now', '-1 hour', 'localtime')
            AND time('now', '+1 hour', 'localtime')
          )
)
SELECT 
    w.route_short_name AS route,
    w.route_long_name AS description,
    w.trip_headsign AS destination,
    w.arrival_time AS scheduled_arrival,
    IFNULL(l.arrival_delay / 60, 0) AS delay_minutes,
    CASE 
        WHEN IFNULL(l.arrival_delay, 0) > 0 THEN 'Delayed'
        WHEN IFNULL(l.arrival_delay, 0) < 0 THEN 'Early'
        ELSE 'On Time'
    END AS delay_status,
    time(
        strftime('%s', w.arrival_time) + IFNULL(l.arrival_delay, 0),
        'unixepoch'
    ) AS expected_arrival,
    CASE WHEN l.trip_id IS NOT NULL THEN 'Y' ELSE 'N' END AS live_hit,
    l.fetched_at
FROM WindowedTrips w
LEFT JOIN live_feed l
    ON w.trip_id = l.trip_id
ORDER BY w.arrival_time;
